
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Usage &#8212; pyfakefs 4.6.dev0 documentation</title>
    <link rel="stylesheet" href="_static/pyfakefs.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Automatically find and patch file functions and modules" href="autopatch.html" />
    <link rel="prev" title="Introduction" href="intro.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="autopatch.html" title="Automatically find and patch file functions and modules"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyfakefs 4.6.dev0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="test-scenarios">
<h2>Test Scenarios<a class="headerlink" href="#test-scenarios" title="Permalink to this headline">¶</a></h2>
<p>There are several approaches for implementing tests using <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.</p>
<div class="section" id="patch-using-fake-filesystem-unittest">
<h3>Patch using fake_filesystem_unittest<a class="headerlink" href="#patch-using-fake-filesystem-unittest" title="Permalink to this headline">¶</a></h3>
<p>If you are using the Python <code class="docutils literal notranslate"><span class="pre">unittest</span></code> package, the easiest approach is to
use test classes derived from <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.TestCase</span></code>.</p>
<p>If you call <code class="docutils literal notranslate"><span class="pre">setUpPyfakefs()</span></code> in your <code class="docutils literal notranslate"><span class="pre">setUp()</span></code>, <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> will
automatically find all real file functions and modules, and stub these out
with the fake file system functions and modules:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">ExampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_create_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/test/file.txt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
</pre></div>
</div>
<p>The usage is explained in more detail in <a class="reference internal" href="autopatch.html#auto-patch"><span class="std std-ref">Automatically find and patch file functions and modules</span></a> and
demonstrated in the files <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/blob/master/pyfakefs/tests/example.py">example.py</a>
and <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/blob/master/pyfakefs/tests/example_test.py">example_test.py</a>.</p>
</div>
<div class="section" id="patch-using-the-pytest-plugin">
<h3>Patch using the pytest plugin<a class="headerlink" href="#patch-using-the-pytest-plugin" title="Permalink to this headline">¶</a></h3>
<p>If you use <a class="reference external" href="https://doc.pytest.org">pytest</a>, you will be interested in
the pytest plugin in <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.
This automatically patches all file system functions and modules in a
similar manner as described above.</p>
<p>The pytest plugin provides the <code class="docutils literal notranslate"><span class="pre">fs</span></code> fixture for use in your test. The plugin
is registered for pytest on installing <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> as usual for pytest
plugins, so you can just use it:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_fakefs_test</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="c1"># &quot;fs&quot; is the reference to the fake file system</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s1">&#39;/var/data/xx1.txt&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/var/data/xx1.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you are bothered by the <code class="docutils literal notranslate"><span class="pre">pylint</span></code> warning,
<code class="docutils literal notranslate"><span class="pre">C0103:</span> <span class="pre">Argument</span> <span class="pre">name</span> <span class="pre">&quot;fs&quot;</span> <span class="pre">doesn't</span> <span class="pre">conform</span> <span class="pre">to</span> <span class="pre">snake_case</span> <span class="pre">naming</span> <span class="pre">style</span>
<span class="pre">(invalid-name)</span></code>,
you can define a longer name in your <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> and use that in your
tests:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fake_filesystem</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>  <span class="c1"># pylint:disable=invalid-name</span>
    <span class="sd">&quot;&quot;&quot;Variable name &#39;fs&#39; causes a pylint warning. Provide a longer name</span>
<span class="sd">    acceptable to pylint for use in tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="n">fs</span>
</pre></div>
</div>
</div>
<div class="section" id="patch-using-fake-filesystem-unittest-patcher">
<h3>Patch using fake_filesystem_unittest.Patcher<a class="headerlink" href="#patch-using-fake-filesystem-unittest-patcher" title="Permalink to this headline">¶</a></h3>
<p>If you are using other means of testing like <a class="reference external" href="http://nose2.readthedocs.io">nose</a>,
you can do the patching using <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.Patcher</span></code>–the class
doing the actual work of replacing the filesystem modules with the fake modules
in the first two approaches.</p>
<p>The easiest way is to just use <code class="docutils literal notranslate"><span class="pre">Patcher</span></code> as a context manager:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">Patcher</span>

<span class="k">with</span> <span class="n">Patcher</span><span class="p">()</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
    <span class="c1"># access the fake_filesystem object via patcher.fs</span>
    <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s1">&#39;/foo/bar&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

    <span class="c1"># the following code works on the fake filesystem</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/foo/bar&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also initialize <code class="docutils literal notranslate"><span class="pre">Patcher</span></code> manually:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">Patcher</span>

<span class="n">patcher</span> <span class="o">=</span> <span class="n">Patcher</span><span class="p">()</span>
<span class="n">patcher</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>     <span class="c1"># called in the initialization code</span>
<span class="o">...</span>
<span class="n">patcher</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>  <span class="c1"># somewhere in the cleanup code</span>
</pre></div>
</div>
</div>
<div class="section" id="patch-using-fake-filesystem-unittest-patchfs-decorator">
<h3>Patch using fake_filesystem_unittest.patchfs decorator<a class="headerlink" href="#patch-using-fake-filesystem-unittest-patchfs-decorator" title="Permalink to this headline">¶</a></h3>
<p>This is basically a convenience wrapper for the previous method.
If you are not using <code class="docutils literal notranslate"><span class="pre">pytest</span></code> and  want to use the fake filesystem for a
single function, you can write:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">patchfs</span>

<span class="nd">@patchfs</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fake_fs</span><span class="p">):</span>
    <span class="c1"># access the fake_filesystem object via fake_fs</span>
    <span class="n">fake_fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s1">&#39;/foo/bar&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">fake_fs</span></code> is a positional argument and the argument name does
not matter. If there are additional <code class="docutils literal notranslate"><span class="pre">mock.patch</span></code> decorators that also
create positional arguments, the argument order is the same as the decorator
order, as shown here:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@patchfs</span>
<span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;foo.bar&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fake_fs</span><span class="p">,</span> <span class="n">mocked_bar</span><span class="p">):</span>
    <span class="o">...</span>

<span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;foo.bar&#39;</span><span class="p">)</span>
<span class="nd">@patchfs</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">mocked_bar</span><span class="p">,</span> <span class="n">fake_fs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Avoid writing the <code class="docutils literal notranslate"><span class="pre">patchfs</span></code> decorator <em>between</em> <code class="docutils literal notranslate"><span class="pre">mock.patch</span></code> operators,
as the order will not be what you expect. Due to implementation details,
all arguments created by <code class="docutils literal notranslate"><span class="pre">mock.patch</span></code> decorators are always expected to
be contiguous, regardless of other decorators positioned between them.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">In previous versions, the keyword argument <cite>fs</cite> has been used instead,
which had to be positioned <em>after</em> all positional arguments regardless of
the decorator order. If you upgrade from a version before pyfakefs 4.2,
you may have to adapt the argument order.</p>
</div>
<p>You can also use this to make a single unit test use the fake fs:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestSomething</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@patchfs</span>
    <span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s1">&#39;/foo/bar&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="customizing-patching">
<span id="customizing-patcher"></span><h2>Customizing patching<a class="headerlink" href="#customizing-patching" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.Patcher</span></code> provides a few arguments to adapt
patching for cases where it does not work out of the box. These arguments
can also be used with <code class="docutils literal notranslate"><span class="pre">unittest</span></code> and <code class="docutils literal notranslate"><span class="pre">pytest</span></code>.</p>
<div class="section" id="using-custom-arguments">
<h3>Using custom arguments<a class="headerlink" href="#using-custom-arguments" title="Permalink to this headline">¶</a></h3>
<p>The following sections describe how to apply these arguments in different
scenarios, using the argument <a class="reference internal" href="#allow-root-user"><span class="std std-ref">allow_root_user</span></a> as an example.</p>
<div class="section" id="patcher">
<h4>Patcher<a class="headerlink" href="#patcher" title="Permalink to this headline">¶</a></h4>
<p>If you use the <code class="docutils literal notranslate"><span class="pre">Patcher</span></code> directly, you can just pass the arguments in the
constructor:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">Patcher</span>

<span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">allow_root_user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="unittest">
<h4>Unittest<a class="headerlink" href="#unittest" title="Permalink to this headline">¶</a></h4>
<p>If you are using <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.TestCase</span></code>, the arguments can be
passed to <code class="docutils literal notranslate"><span class="pre">setUpPyfakefs()</span></code>, which will pass them to the <code class="docutils literal notranslate"><span class="pre">Patcher</span></code>
instance:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">SomeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">(</span><span class="n">allow_root_user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">testSomething</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="pytest">
<h4>Pytest<a class="headerlink" href="#pytest" title="Permalink to this headline">¶</a></h4>
<p>In case of <code class="docutils literal notranslate"><span class="pre">pytest</span></code>, you have two possibilities:</p>
<ul class="simple">
<li>The standard way to customize the <code class="docutils literal notranslate"><span class="pre">fs</span></code> fixture is to write your own
fixture which uses the <code class="docutils literal notranslate"><span class="pre">Patcher</span></code> with arguments as has been shown above:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">Patcher</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fs_no_root</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">allow_root_user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span>

<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fs_no_root</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<ul class="simple">
<li>You can also pass the arguments using <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.parametrize</span></code>. Note that
you have to provide
<a class="reference external" href="http://jmcgeheeiv.github.io/pyfakefs/master/modules.html#pyfakefs.fake_filesystem_unittest.Patcher">all Patcher arguments</a>
before the needed ones, as keyword arguments cannot be used, and you have to
add <code class="docutils literal notranslate"><span class="pre">indirect=True</span></code>. This makes it less readable, but gives
you a quick possibility to adapt a single test:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="patchfs">
<h4>patchfs<a class="headerlink" href="#patchfs" title="Permalink to this headline">¶</a></h4>
<p>If you use the <code class="docutils literal notranslate"><span class="pre">patchfs</span></code> decorator, you can pass the arguments directly to
the decorator:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">patchfs</span>

<span class="nd">@patchfs</span><span class="p">(</span><span class="n">allow_root_user</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fake_fs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="list-of-custom-arguments">
<h3>List of custom arguments<a class="headerlink" href="#list-of-custom-arguments" title="Permalink to this headline">¶</a></h3>
<p>Following is a description of the optional arguments that can be used to
customize <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.</p>
<div class="section" id="modules-to-reload">
<span id="id1"></span><h4>modules_to_reload<a class="headerlink" href="#modules-to-reload" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Pyfakefs</span></code> patches modules that are imported before starting the test by
finding and replacing file system modules in all loaded modules at test
initialization time.
This allows to automatically patch file system related modules that are:</p>
<ul class="simple">
<li>imported directly, for example:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib.Path</span>
</pre></div>
</div>
<ul class="simple">
<li>imported as another name:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">my_os</span>
</pre></div>
</div>
<ul class="simple">
<li>imported using one of these two specially handled statements:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
</pre></div>
</div>
<p>Additionally, functions from file system related modules are patched
automatically if imported like:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">stat</span>
</pre></div>
</div>
<p>This also works if importing the functions as another name:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">exists</span> <span class="k">as</span> <span class="n">my_exists</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">io_open</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">bltn_open</span>
</pre></div>
</div>
<p>There are a few cases where automatic patching does not work. We know of at
least two specific cases where this is the case:</p>
<p>Initializing a default argument with a file system function is not patched
automatically due to performance reasons (though it can be switched on using
<a class="reference internal" href="#patch-default-args"><span class="std std-ref">patch_default_args</span></a>):</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">check_if_exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">file_exists</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">file_exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>
</div>
<p>If initializing a global variable using a file system function, the
initialization will be done using the real file system:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/example_home&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">path</span></code> will hold the real file system path inside the test.
The same is true, if a file system function is used in a decorator (this is
an example from a related issue):</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pathlib</span>

<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_type</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">foo</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>To get these cases to work as expected under test, the respective modules
containing the code shall be added to the <code class="docutils literal notranslate"><span class="pre">modules_to_reload</span></code> argument (a
module list).
The passed modules will be reloaded, thus allowing <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> to patch them
dynamically. All modules loaded after the initial patching described above
will be patched using this second mechanism.</p>
<p>Given that the example function <code class="docutils literal notranslate"><span class="pre">check_if_exists</span></code> shown above is located in
the file <code class="docutils literal notranslate"><span class="pre">example/sut.py</span></code>, the following code will work:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">example</span>

<span class="c1"># example using unittest</span>
<span class="k">class</span> <span class="nc">ReloadModuleTest</span><span class="p">(</span><span class="n">fake_filesystem_unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">(</span><span class="n">modules_to_reload</span><span class="o">=</span><span class="p">[</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

<span class="c1"># example using pytest</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="p">]]],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

<span class="c1"># example using Patcher</span>
<span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">modules_to_reload</span><span class="o">=</span><span class="p">[</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="p">])</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
      <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
      <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
      <span class="k">assert</span> <span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

<span class="c1"># example using patchfs decorator</span>
<span class="nd">@patchfs</span><span class="p">(</span><span class="n">modules_to_reload</span><span class="o">=</span><span class="p">[</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="modules-to-patch">
<h4>modules_to_patch<a class="headerlink" href="#modules-to-patch" title="Permalink to this headline">¶</a></h4>
<p>Sometimes there are file system modules in other packages that are not
patched in standard <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>. To allow patching such modules,
<code class="docutils literal notranslate"><span class="pre">modules_to_patch</span></code> can be used by adding a fake module implementation for
a module name. The argument is a dictionary of fake modules mapped to the
names to be faked.</p>
<p>This mechanism is used in <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> itself to patch the external modules
<cite>pathlib2</cite> and <cite>scandir</cite> if present, and the following example shows how to
fake a module in Django that uses OS file system functions (note that this
has now been been integrated into <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>):</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeLocks</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;django.core.files.locks uses low level OS functions, fake it.&quot;&quot;&quot;</span>
    <span class="n">_locks_module</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">locks</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Each fake module expects the fake file system as an __init__</span>
<span class="sd">        parameter.&quot;&quot;&quot;</span>
        <span class="c1"># fs represents the fake filesystem; for a real example, it can be</span>
        <span class="c1"># saved here and used in the implementation</span>
        <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_locks_module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="o">...</span>
<span class="c1"># test code using Patcher</span>
<span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">modules_to_patch</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;django.core.files.locks&#39;</span><span class="p">:</span> <span class="n">FakeLocks</span><span class="p">}):</span>
    <span class="n">test_django_stuff</span><span class="p">()</span>

<span class="c1"># test code using unittest</span>
<span class="k">class</span> <span class="nc">TestUsingDjango</span><span class="p">(</span><span class="n">fake_filesystem_unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">(</span><span class="n">modules_to_patch</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;django.core.files.locks&#39;</span><span class="p">:</span> <span class="n">FakeLocks</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">test_django_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="o">...</span>

<span class="c1"># test code using pytest</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">{</span><span class="s1">&#39;django.core.files.locks&#39;</span><span class="p">:</span> <span class="n">FakeLocks</span><span class="p">}]],</span> <span class="n">indirect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_django_stuff</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># test code using patchfs decorator</span>
<span class="nd">@patchfs</span><span class="p">(</span><span class="n">modules_to_patch</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;django.core.files.locks&#39;</span><span class="p">:</span> <span class="n">FakeLocks</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">test_django_stuff</span><span class="p">(</span><span class="n">fake_fs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-skip-names">
<h4>additional_skip_names<a class="headerlink" href="#additional-skip-names" title="Permalink to this headline">¶</a></h4>
<p>This may be used to add modules that shall not be patched. This is mostly
used to avoid patching the Python file system modules themselves, but may be
helpful in some special situations, for example if a testrunner needs to access
the file system after test setup. To make this possible, the affected module
can be added to <code class="docutils literal notranslate"><span class="pre">additional_skip_names</span></code>:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">additional_skip_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pydevd&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
    <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively to the module names, the modules themselves may be used:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pydevd</span>

<span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">additional_skip_names</span><span class="o">=</span><span class="p">[</span><span class="n">pydevd</span><span class="p">])</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
    <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="allow-root-user">
<span id="id2"></span><h4>allow_root_user<a class="headerlink" href="#allow-root-user" title="Permalink to this headline">¶</a></h4>
<p>This is <code class="docutils literal notranslate"><span class="pre">True</span></code> by default, meaning that the user is considered a root user
if the real user is a root user (e.g. has the user ID 0). If you want to run
your tests as a non-root user regardless of the actual user rights, you may
want to set this to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</div>
<div class="section" id="use-known-patches">
<h4>use_known_patches<a class="headerlink" href="#use-known-patches" title="Permalink to this headline">¶</a></h4>
<p>Some libraries are known to require patching in order to work with
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.
If <code class="docutils literal notranslate"><span class="pre">use_known_patches</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> (the default), <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> patches
these libraries so that they will work with the fake filesystem. Currently, this
includes patches for <code class="docutils literal notranslate"><span class="pre">pandas</span></code> read methods like <code class="docutils literal notranslate"><span class="pre">read_csv</span></code> and
<code class="docutils literal notranslate"><span class="pre">read_excel</span></code>, and for <code class="docutils literal notranslate"><span class="pre">Django</span></code> file locks–more may follow. Ordinarily,
the default value of <code class="docutils literal notranslate"><span class="pre">use_known_patches</span></code> should be used, but it is present
to allow users to disable this patching in case it causes any problems. It
may be removed or replaced by more fine-grained arguments in future releases.</p>
</div>
<div class="section" id="patch-open-code">
<h4>patch_open_code<a class="headerlink" href="#patch-open-code" title="Permalink to this headline">¶</a></h4>
<p>Since Python 3.8, the <code class="docutils literal notranslate"><span class="pre">io</span></code> module has the function <code class="docutils literal notranslate"><span class="pre">open_code</span></code>, which
opens a file read-only and is used to open Python code files. By default, this
function is not patched, because the files it opens usually belong to the
executed library code and are not present in the fake file system.
Under some circumstances, this may not be the case, and the opened file
lives in the fake filesystem. For these cases, you can set <code class="docutils literal notranslate"><span class="pre">patch_open_code</span></code>
to <code class="docutils literal notranslate"><span class="pre">PatchMode.ON</span></code>. If you just want to patch <code class="docutils literal notranslate"><span class="pre">open_case</span></code> for files that
live in the fake filesystem, and use the real function for the rest, you can
set <code class="docutils literal notranslate"><span class="pre">patch_open_code</span></code> to <code class="docutils literal notranslate"><span class="pre">PatchMode.AUTO</span></code>:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">PatchMode</span>

<span class="nd">@patchfs</span><span class="p">(</span><span class="n">patch_open_code</span><span class="o">=</span><span class="n">PatchMode</span><span class="o">.</span><span class="n">AUTO</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This argument is subject to change or removal in future
versions of <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, depending on the upcoming use cases.</p>
</div>
</div>
<div class="section" id="patch-default-args">
<span id="id3"></span><h4>patch_default_args<a class="headerlink" href="#patch-default-args" title="Permalink to this headline">¶</a></h4>
<p>As already mentioned, a default argument that is initialized with a file
system function is not patched automatically:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">check_if_exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">file_exists</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">file_exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>
</div>
<p>As this is rarely needed, and the check to patch this automatically is quite
expansive, it is not done by default. Using <code class="docutils literal notranslate"><span class="pre">patch_default_args</span></code> will
search for this kind of default arguments and patch them automatically.
You could also use the <a class="reference internal" href="#modules-to-reload"><span class="std std-ref">modules_to_reload</span></a> option with the module that
contains the default argument instead, if you want to avoid the overhead.</p>
</div>
<div class="section" id="use-cache">
<h4>use_cache<a class="headerlink" href="#use-cache" title="Permalink to this headline">¶</a></h4>
<p>If True (the default), patched and non-patched modules are cached between tests
to avoid the performance hit of the file system function lookup (the
patching itself is reverted after each test). As this is a new
feature, this argument allows to turn it off in case it causes any problems:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@patchfs</span><span class="p">(</span><span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fake_fs</span><span class="p">):</span>
    <span class="n">fake_fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Please write an issue if you encounter any problem that can be fixed by using
this parameter. Note that this argument may be removed in a later version, if
no problems come up.</p>
<p>If you want to clear the cache just for a specific test instead, you can call
<code class="docutils literal notranslate"><span class="pre">clear_cache</span></code> on the <code class="docutils literal notranslate"><span class="pre">Patcher</span></code> or the <code class="docutils literal notranslate"><span class="pre">fake_filesystem</span></code> instance:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>  <span class="c1"># using pytest fixture</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-convenience-methods">
<h2>Using convenience methods<a class="headerlink" href="#using-convenience-methods" title="Permalink to this headline">¶</a></h2>
<p>While <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> can be used just with the standard Python file system
functions, there are few convenience methods in <code class="docutils literal notranslate"><span class="pre">fake_filesystem</span></code> that can
help you setting up your tests. The methods can be accessed via the
<code class="docutils literal notranslate"><span class="pre">fake_filesystem</span></code> instance in your tests: <code class="docutils literal notranslate"><span class="pre">Patcher.fs</span></code>, the <code class="docutils literal notranslate"><span class="pre">fs</span></code>
fixture in pytest, <code class="docutils literal notranslate"><span class="pre">TestCase.fs</span></code> for <code class="docutils literal notranslate"><span class="pre">unittest</span></code>, and the <code class="docutils literal notranslate"><span class="pre">fs</span></code> argument
for the <code class="docutils literal notranslate"><span class="pre">patchfs</span></code> decorator.</p>
<div class="section" id="file-creation-helpers">
<h3>File creation helpers<a class="headerlink" href="#file-creation-helpers" title="Permalink to this headline">¶</a></h3>
<p>To create files, directories or symlinks together with all the directories
in the path, you may use <code class="docutils literal notranslate"><span class="pre">create_file()</span></code>, <code class="docutils literal notranslate"><span class="pre">create_dir()</span></code>,
<code class="docutils literal notranslate"><span class="pre">create_symlink()</span></code> and <code class="docutils literal notranslate"><span class="pre">create_link()</span></code>, respectively.</p>
<p><code class="docutils literal notranslate"><span class="pre">create_file()</span></code> also allows you to set the file mode and the file contents
together with the encoding if needed. Alternatively, you can define a file
size without contents–in this case, you will not be able to perform
standard IO operations on the file (may be used to fill up the file system
with large files, see also <a class="reference internal" href="#set-fs-size"><span class="std std-ref">Setting the file system size</span></a>).</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">ExampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_create_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar/test.txt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">contents</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">create_dir()</span></code> behaves like <code class="docutils literal notranslate"><span class="pre">os.makedirs()</span></code>.
<code class="docutils literal notranslate"><span class="pre">create_symlink</span></code> and <code class="docutils literal notranslate"><span class="pre">create_link</span></code> behave like <code class="docutils literal notranslate"><span class="pre">os.symlink</span></code> and
<code class="docutils literal notranslate"><span class="pre">os.link</span></code>, with any missing parent directories of the link created
automatically.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">The first two arguments in <code class="docutils literal notranslate"><span class="pre">create_symlink</span></code> are reverted in relation to
<code class="docutils literal notranslate"><span class="pre">os.symlink</span></code> for historical reasons.</p>
</div>
</div>
<div class="section" id="access-to-files-in-the-real-file-system">
<h3>Access to files in the real file system<a class="headerlink" href="#access-to-files-in-the-real-file-system" title="Permalink to this headline">¶</a></h3>
<p>If you want to have read access to real files or directories, you can map
them into the fake file system using <code class="docutils literal notranslate"><span class="pre">add_real_file()</span></code>,
<code class="docutils literal notranslate"><span class="pre">add_real_directory()</span></code>, <code class="docutils literal notranslate"><span class="pre">add_real_symlink()</span></code> and <code class="docutils literal notranslate"><span class="pre">add_real_paths()</span></code>.
They take a file path, a directory path, a symlink path, or a list of paths,
respectively, and make them accessible from the fake file system. By
default, the contents of the mapped files and directories are read only on
demand, so that mapping them is relatively cheap. The access to the files is
by default read-only, but even if you add them using <code class="docutils literal notranslate"><span class="pre">read_only=False</span></code>,
the files are written only in the fake system (e.g. in memory). The real
files are never changed.</p>
<p><code class="docutils literal notranslate"><span class="pre">add_real_file()</span></code>, <code class="docutils literal notranslate"><span class="pre">add_real_directory()</span></code> and <code class="docutils literal notranslate"><span class="pre">add_real_symlink()</span></code> also
allow you to map a file or a directory tree into another location in the
fake filesystem via the argument <code class="docutils literal notranslate"><span class="pre">target_path</span></code>.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">ExampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="n">fixture_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;fixtures&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">()</span>
        <span class="c1"># make the file accessible in the fake file system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">add_real_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_using_fixture1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixture_path</span><span class="p">,</span> <span class="s1">&#39;fixture1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># file contents are copied to the fake file system</span>
            <span class="c1"># only at this point</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>You can do the same using <code class="docutils literal notranslate"><span class="pre">pytest</span></code> by using a fixture for test setup:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">fixture_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;fixtures&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">my_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">add_real_directory</span><span class="p">(</span><span class="n">fixture_path</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">fs</span>

<span class="k">def</span> <span class="nf">test_using_fixture1</span><span class="p">(</span><span class="n">my_fs</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fixture_path</span><span class="p">,</span> <span class="s1">&#39;fixture1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">pytest</span></code> another option is to load the contents of the real file
in a fixture and pass this fixture to the test function <strong>before</strong> passing
the <code class="docutils literal notranslate"><span class="pre">fs</span></code> fixture.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">content</span><span class="p">():</span>
    <span class="n">fixture_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;fixtures&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fixture_path</span><span class="p">,</span> <span class="s1">&#39;fixture1.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">contents</span>

<span class="k">def</span> <span class="nf">test_using_file_contents</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">create_file</span><span class="p">(</span><span class="s2">&quot;fake/path.txt&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">content</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="handling-mount-points">
<h3>Handling mount points<a class="headerlink" href="#handling-mount-points" title="Permalink to this headline">¶</a></h3>
<p>Under Linux and MacOS, the root path (<code class="docutils literal notranslate"><span class="pre">/</span></code>) is the only mount point created
in the fake file system. If you need support for more mount points, you can add
them using <code class="docutils literal notranslate"><span class="pre">add_mount_point()</span></code>.</p>
<p>Under Windows, drives and UNC paths are internally handled as mount points.
Adding a file or directory on another drive or UNC path automatically
adds a mount point for that drive or UNC path root if needed. Explicitly
adding mount points shall not be needed under Windows.</p>
<p>A mount point has a separate device ID (<code class="docutils literal notranslate"><span class="pre">st_dev</span></code>) under all systems, and
some operations (like <code class="docutils literal notranslate"><span class="pre">rename</span></code>) are not possible for files located on
different mount points. The fake file system size (if used) is also set per
mount point.</p>
</div>
<div class="section" id="setting-the-file-system-size">
<span id="set-fs-size"></span><h3>Setting the file system size<a class="headerlink" href="#setting-the-file-system-size" title="Permalink to this headline">¶</a></h3>
<p>If you need to know the file system size in your tests (for example for
testing cleanup scripts), you can set the fake file system size using
<code class="docutils literal notranslate"><span class="pre">set_disk_usage()</span></code>. By default, this sets the total size in bytes of the
root partition; if you add a path as parameter, the size will be related to
the mount point (see above) the path is related to.</p>
<p>By default, the size of the fake file system is set to 1 TB (which
for most tests can be considered as infinite). As soon as you set a
size, all files will occupy the space according to their size,
and you may fail to create new files if the fake file system is full.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">ExampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">set_disk_usage</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_disk_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/foo/bar.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
</div>
<p>To get the file system size, you may use <code class="docutils literal notranslate"><span class="pre">get_disk_usage()</span></code>, which is
modeled after <code class="docutils literal notranslate"><span class="pre">shutil.disk_usage()</span></code>.</p>
</div>
<div class="section" id="suspending-patching">
<h3>Suspending patching<a class="headerlink" href="#suspending-patching" title="Permalink to this headline">¶</a></h3>
<p>Sometimes, you may want to access the real filesystem inside the test with
no patching applied. This can be achieved by using the <code class="docutils literal notranslate"><span class="pre">pause/resume</span></code>
functions, which exist in <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.Patcher</span></code>,
<code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.TestCase</span></code> and <code class="docutils literal notranslate"><span class="pre">fake_filesystem.FakeFilesystem</span></code>.
There is also a context manager class <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.Pause</span></code>
which encapsulates the calls to <code class="docutils literal notranslate"><span class="pre">pause()</span></code> and <code class="docutils literal notranslate"><span class="pre">resume()</span></code>.</p>
<p>Here is an example that tests the usage with the <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> pytest fixture:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">Pause</span>

<span class="k">def</span> <span class="nf">test_pause_resume_contextmanager</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fake_temp_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fake_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fake_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">real_temp_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fake_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the same code using a context manager:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem_unittest</span> <span class="k">import</span> <span class="n">Pause</span>

<span class="k">def</span> <span class="nf">test_pause_resume_contextmanager</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fake_temp_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fake_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Pause</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fake_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">real_temp_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fake_temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="simulating-other-file-systems">
<h3>Simulating other file systems<a class="headerlink" href="#simulating-other-file-systems" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Pyfakefs</span></code> supports Linux, MacOS and Windows operating systems. By default,
the file system of the OS where the tests run is assumed, but it is possible
to simulate other file systems to some extent. To set a specific file
system, you can change <code class="docutils literal notranslate"><span class="pre">pyfakefs.FakeFilesystem.os</span></code> to one of
<code class="docutils literal notranslate"><span class="pre">OSType.LINUX</span></code>, <code class="docutils literal notranslate"><span class="pre">OSType.MACOS</span></code> and <code class="docutils literal notranslate"><span class="pre">OSType.WINDOWS</span></code>. On doing so, the
behavior of <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> is adapted to the respective file system. Note that
setting this causes the fake file system to be reset, so you should call it
before adding any files.</p>
<p>Setting the <code class="docutils literal notranslate"><span class="pre">os</span></code> attributes changes a number of <code class="docutils literal notranslate"><span class="pre">pyfakefs.FakeFilesystem</span></code>
attributes, which can also be set separately if needed:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">is_windows_fs</span></code> -  if <code class="docutils literal notranslate"><span class="pre">True</span></code> a Windows file system (NTFS) is assumed</li>
<li><code class="docutils literal notranslate"><span class="pre">is_macos</span></code> - if <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">is_windows_fs</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>, the
standard MacOS file system (HFS+) is assumed</li>
<li>if <code class="docutils literal notranslate"><span class="pre">is_windows_fs</span></code> and <code class="docutils literal notranslate"><span class="pre">is_macos</span></code> are <code class="docutils literal notranslate"><span class="pre">False</span></code>, a Linux file system
(something like ext3) is assumed</li>
<li><code class="docutils literal notranslate"><span class="pre">is_case_sensitive</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> under Linux and to <code class="docutils literal notranslate"><span class="pre">False</span></code>
under Windows and MacOS by default - you can change it to change the
respective behavior</li>
<li><code class="docutils literal notranslate"><span class="pre">path_separator</span></code> is set to <code class="docutils literal notranslate"><span class="pre">\</span></code> under Windows and to <code class="docutils literal notranslate"><span class="pre">/</span></code> under Posix,
<code class="docutils literal notranslate"><span class="pre">alternative_path_separator</span></code> is set to <code class="docutils literal notranslate"><span class="pre">/</span></code> under Windows and to
<code class="docutils literal notranslate"><span class="pre">None</span></code> under Posix–these can also be adapted if needed</li>
</ul>
</div></blockquote>
<p>The following test works both under Windows and Linux:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyfakefs.fake_filesystem</span> <span class="k">import</span> <span class="n">OSType</span>

<span class="k">def</span> <span class="nf">test_windows_paths</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">OSType</span><span class="o">.</span><span class="n">WINDOWS</span>
    <span class="k">assert</span> <span class="sa">r</span><span class="s2">&quot;C:\foo\bar&quot;</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;C:\foo\bar&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;C:&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\foo\bar&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">ismount</span><span class="p">(</span><span class="s2">&quot;C:&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<div class="section" id="modules-not-working-with-pyfakefs">
<h3>Modules not working with pyfakefs<a class="headerlink" href="#modules-not-working-with-pyfakefs" title="Permalink to this headline">¶</a></h3>
<p>Modules may not work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> for several reasons. <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>
works by patching some file system related modules and functions, specifically:</p>
<ul class="simple">
<li>most file system related functions in the <code class="docutils literal notranslate"><span class="pre">os</span></code> and <code class="docutils literal notranslate"><span class="pre">os.path</span></code> modules</li>
<li>the <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> module</li>
<li>the build-in <code class="docutils literal notranslate"><span class="pre">open</span></code> function and <code class="docutils literal notranslate"><span class="pre">io.open</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">shutil.disk_usage</span></code></li>
</ul>
<p>Other file system related modules work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, because they use
exclusively these patched functions, specifically <code class="docutils literal notranslate"><span class="pre">shutil</span></code> (except for
<code class="docutils literal notranslate"><span class="pre">disk_usage</span></code>), <code class="docutils literal notranslate"><span class="pre">tempfile</span></code>, <code class="docutils literal notranslate"><span class="pre">glob</span></code> and <code class="docutils literal notranslate"><span class="pre">zipfile</span></code>.</p>
<p>A module may not work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> because of one of the following
reasons:</p>
<ul class="simple">
<li>It uses a file system related function of the mentioned modules that is
not or not correctly patched. Mostly these are functions that are seldom
used, but may be used in Python libraries (this has happened for example
with a changed implementation of <code class="docutils literal notranslate"><span class="pre">shutil</span></code> in Python 3.7). Generally,
these shall be handled in issues and we are happy to fix them.</li>
<li>It uses file system related functions in a way that will not be patched
automatically. This is the case for functions that are executed while
reading a module. This case and a possibility to make them work is
documented above under <code class="docutils literal notranslate"><span class="pre">modules_to_reload</span></code>.</li>
<li>It uses OS specific file system functions not contained in the Python
libraries. These will not work out of the box, and we generally will not
support them in <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>. If these functions are used in isolated
functions or classes, they may be patched by using the <code class="docutils literal notranslate"><span class="pre">modules_to_patch</span></code>
parameter (see the example for file locks in Django above), or by using
<code class="docutils literal notranslate"><span class="pre">unittest.patch</span></code> if you don’t need to simulate the functions. We
added some of these patches to <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, so that they are applied
automatically (currently done for some <code class="docutils literal notranslate"><span class="pre">pandas</span></code> and <code class="docutils literal notranslate"><span class="pre">Django</span></code>
functionality).</li>
<li>It uses C libraries to access the file system. There is no way no make
such a module work with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>–if you want to use it, you
have to patch the whole module. In some cases, a library implemented in
Python with a similar interface already exists. An example is <code class="docutils literal notranslate"><span class="pre">lxml</span></code>,
which can be substituted with <code class="docutils literal notranslate"><span class="pre">ElementTree</span></code> in most cases for testing.</li>
</ul>
<p>A list of Python modules that are known to not work correctly with
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> will be collected here:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> has several issues (related to points 1 and 3 above).
Currently there are no plans to fix this, but this may change in case of
sufficient demand.</li>
<li><code class="docutils literal notranslate"><span class="pre">subprocess</span></code> has very similar problems and cannot be used with
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> to start a process. <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> can either be mocked, if
the process is not needed for the test, or patching can be paused to start
a process if needed, and resumed afterwards
(see <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/issues/447">this issue</a>).</li>
<li>the <code class="docutils literal notranslate"><span class="pre">Pillow</span></code> image library does not work with pyfakefs at least if writing
JPEG files (see <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/issues/529">this issue</a>)</li>
<li><code class="docutils literal notranslate"><span class="pre">pandas</span></code> (the Python data analysis library) uses its own internal file
system access written in C. Thus much of <code class="docutils literal notranslate"><span class="pre">pandas</span></code> will not work with
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>. Having said that, <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> patches <code class="docutils literal notranslate"><span class="pre">pandas</span></code> so that many
of the <code class="docutils literal notranslate"><span class="pre">read_xxx</span></code> functions, including <code class="docutils literal notranslate"><span class="pre">read_csv</span></code> and <code class="docutils literal notranslate"><span class="pre">read_excel</span></code>,
as well as some writer functions, do work with the fake file system. If
you use only these functions, <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> will work with <code class="docutils literal notranslate"><span class="pre">pandas</span></code>.</li>
</ul>
<p>If you are not sure if a module can be handled, or how to do it, you can
always write a new issue, of course!</p>
</div>
<div class="section" id="pyfakefs-behaves-differently-than-the-real-filesystem">
<h3>Pyfakefs behaves differently than the real filesystem<a class="headerlink" href="#pyfakefs-behaves-differently-than-the-real-filesystem" title="Permalink to this headline">¶</a></h3>
<p>There are basically two kinds of deviations from the actual behavior:</p>
<ul class="simple">
<li>unwanted deviations that we didn’t notice–if you find any of these, please
write an issue and will try to fix it</li>
<li>behavior that depends on different OS versions and editions–as mentioned
in <a class="reference internal" href="intro.html#limitations"><span class="std std-ref">Limitations</span></a>, <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> uses the TravisCI systems as reference
system and will not replicate all system-specific behavior</li>
</ul>
</div>
<div class="section" id="os-temporary-directories">
<h3>OS temporary directories<a class="headerlink" href="#os-temporary-directories" title="Permalink to this headline">¶</a></h3>
<p>Tests relying on a completely empty file system on test start will fail.
As <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> does not fake the <code class="docutils literal notranslate"><span class="pre">tempfile</span></code> module (as described above),
a temporary directory is required to ensure <code class="docutils literal notranslate"><span class="pre">tempfile</span></code> works correctly,
e.g., that <code class="docutils literal notranslate"><span class="pre">tempfile.gettempdir()</span></code> will return a valid value. This
means that any newly created fake file system will always have either a
directory named <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> when running on Linux or Unix systems,
<code class="docutils literal notranslate"><span class="pre">/var/folders/&lt;hash&gt;/T</span></code> when running on MacOs, or
<code class="docutils literal notranslate"><span class="pre">C:\Users\&lt;user&gt;\AppData\Local\Temp</span></code> on Windows.</p>
</div>
<div class="section" id="user-rights">
<h3>User rights<a class="headerlink" href="#user-rights" title="Permalink to this headline">¶</a></h3>
<p>If you run <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> tests as root (this happens by default if run in a
docker container), <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> also behaves as a root user, for example can
write to write-protected files. This may not be the expected behavior, and
can be changed.
<code class="docutils literal notranslate"><span class="pre">Pyfakefs</span></code> has a rudimentary concept of user rights, which differentiates
between root user (with the user id 0) and any other user. By default,
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code> assumes the user id of the current user, but you can change
that using <code class="docutils literal notranslate"><span class="pre">fake_filesystem.set_uid()</span></code> in your setup. This allows to run
tests as non-root user in a root user environment and vice verse.
Another possibility to run tests as non-root user in a root user environment
is the convenience argument <a class="reference internal" href="#allow-root-user"><span class="std std-ref">allow_root_user</span></a>.</p>
</div>
<div class="section" id="pyfakefs-and-mock-open">
<span id="usage-with-mock-open"></span><h3>Pyfakefs and mock_open<a class="headerlink" href="#pyfakefs-and-mock-open" title="Permalink to this headline">¶</a></h3>
<p>If you patch <code class="docutils literal notranslate"><span class="pre">open</span></code> using <code class="docutils literal notranslate"><span class="pre">mock_open</span></code> before the initialization of
<code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, it will not work properly, because the <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>
initialization relies on <code class="docutils literal notranslate"><span class="pre">open</span></code> working correctly.
Generally, you should not need <code class="docutils literal notranslate"><span class="pre">mock_open</span></code> if using <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>, because you
always can create the files with the needed content using <code class="docutils literal notranslate"><span class="pre">create_file</span></code>.
This is true for patching any filesystem functions - avoid patching them
while working with <code class="docutils literal notranslate"><span class="pre">pyfakefs</span></code>.
If you still want to use <code class="docutils literal notranslate"><span class="pre">mock_open</span></code>, make sure it is only used while
patching is in progress. For example, if you are using <code class="docutils literal notranslate"><span class="pre">pytest</span></code> with the
<code class="docutils literal notranslate"><span class="pre">mocker</span></code> fixture used to patch <code class="docutils literal notranslate"><span class="pre">open</span></code>, make sure that the <code class="docutils literal notranslate"><span class="pre">fs</span></code> fixture is
passed before the <code class="docutils literal notranslate"><span class="pre">mocker</span></code> fixture to ensure this.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Usage</a><ul>
<li><a class="reference internal" href="#test-scenarios">Test Scenarios</a><ul>
<li><a class="reference internal" href="#patch-using-fake-filesystem-unittest">Patch using fake_filesystem_unittest</a></li>
<li><a class="reference internal" href="#patch-using-the-pytest-plugin">Patch using the pytest plugin</a></li>
<li><a class="reference internal" href="#patch-using-fake-filesystem-unittest-patcher">Patch using fake_filesystem_unittest.Patcher</a></li>
<li><a class="reference internal" href="#patch-using-fake-filesystem-unittest-patchfs-decorator">Patch using fake_filesystem_unittest.patchfs decorator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#customizing-patching">Customizing patching</a><ul>
<li><a class="reference internal" href="#using-custom-arguments">Using custom arguments</a><ul>
<li><a class="reference internal" href="#patcher">Patcher</a></li>
<li><a class="reference internal" href="#unittest">Unittest</a></li>
<li><a class="reference internal" href="#pytest">Pytest</a></li>
<li><a class="reference internal" href="#patchfs">patchfs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#list-of-custom-arguments">List of custom arguments</a><ul>
<li><a class="reference internal" href="#modules-to-reload">modules_to_reload</a></li>
<li><a class="reference internal" href="#modules-to-patch">modules_to_patch</a></li>
<li><a class="reference internal" href="#additional-skip-names">additional_skip_names</a></li>
<li><a class="reference internal" href="#allow-root-user">allow_root_user</a></li>
<li><a class="reference internal" href="#use-known-patches">use_known_patches</a></li>
<li><a class="reference internal" href="#patch-open-code">patch_open_code</a></li>
<li><a class="reference internal" href="#patch-default-args">patch_default_args</a></li>
<li><a class="reference internal" href="#use-cache">use_cache</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#using-convenience-methods">Using convenience methods</a><ul>
<li><a class="reference internal" href="#file-creation-helpers">File creation helpers</a></li>
<li><a class="reference internal" href="#access-to-files-in-the-real-file-system">Access to files in the real file system</a></li>
<li><a class="reference internal" href="#handling-mount-points">Handling mount points</a></li>
<li><a class="reference internal" href="#setting-the-file-system-size">Setting the file system size</a></li>
<li><a class="reference internal" href="#suspending-patching">Suspending patching</a></li>
<li><a class="reference internal" href="#simulating-other-file-systems">Simulating other file systems</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#modules-not-working-with-pyfakefs">Modules not working with pyfakefs</a></li>
<li><a class="reference internal" href="#pyfakefs-behaves-differently-than-the-real-filesystem">Pyfakefs behaves differently than the real filesystem</a></li>
<li><a class="reference internal" href="#os-temporary-directories">OS temporary directories</a></li>
<li><a class="reference internal" href="#user-rights">User rights</a></li>
<li><a class="reference internal" href="#pyfakefs-and-mock-open">Pyfakefs and mock_open</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="intro.html"
                        title="previous chapter">Introduction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="autopatch.html"
                        title="next chapter">Automatically find and patch file functions and modules</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/usage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="autopatch.html" title="Automatically find and patch file functions and modules"
             >next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyfakefs 4.6.dev0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009 Google Inc. All Rights Reserved.
© Copyright 2014 Altera Corporation. All Rights Reserved.
© Copyright 2014-2021 John McGehee.
      Last updated on Nov 07, 2021.
    </div>
  </body>
</html>